<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Battle-Tested Cesium Viewer</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.113/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.113/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />
    <style>
      html, body, #cesiumContainer {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #000;
        color: #fff;
        font-family: monospace;
      }
      #statusLog {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 10;
        background: rgba(0,0,0,0.5);
        padding: 10px;
        font-size: 12px;
        max-width: 400px;
        border: 1px solid #444;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div id="cesiumContainer"></div>
    <div id="statusLog">Initializing viewer...</div>
    <script type="module">
      const log = (msg, isError = false) => {
        console.log(msg);
        const status = document.getElementById("statusLog");
        status.innerHTML += "<br>" + (isError ? "‚ùå " : "‚úÖ ") + msg;
      };

      try {
        if (!Cesium || !Cesium.Viewer) {
          throw new Error("Cesium Viewer is not available.");
        }
        log("Cesium.js loaded.");

        // üîí Fix: Inject your own token
        Cesium.Ion.defaultAccessToken = "YOUR_ACCESS_TOKEN_HERE";

        const terrainProvider = await Cesium.createWorldTerrainAsync();
        log("Terrain provider loaded.");

        const viewer = new Cesium.Viewer("cesiumContainer", {
          terrainProvider,
          sceneMode: Cesium.SceneMode.SCENE3D,
          shouldAnimate: true
        });
        log("Viewer initialized.");

        viewer.scene.globe.enableLighting = true;

        viewer.camera.flyTo({
          destination: Cesium.Cartesian3.fromDegrees(-118.4085, 33.9416, 3000),
          orientation: {
            heading: Cesium.Math.toRadians(0),
            pitch: Cesium.Math.toRadians(-30),
            roll: 0.0
          }
        });
        log("Camera set to LAX.");

        const glbModelUrl = "airspace.glb";
        log("Trying to load model: " + glbModelUrl);

        let retries = 2;
        let modelLoaded = false;

        async function tryLoadModel(attempt = 1) {
          try {
            const model = await Cesium.Model.fromGltfAsync({
              url: glbModelUrl,
              modelMatrix: Cesium.Transforms.eastNorthUpToFixedFrame(
                Cesium.Cartesian3.fromDegrees(-118.4085, 33.9416, 1000)
              ),
              scale: 1.0,
            });
            viewer.scene.primitives.add(model);
            log(`Model loaded on attempt #${attempt}`);
            modelLoaded = true;
          } catch (error) {
            log(`Attempt #${attempt} failed to load GLB. Reason: ${error.message}`, true);
            if (attempt < retries) {
              log("Retrying...");
              await tryLoadModel(attempt + 1);
            } else {
              log("Failed to load model after retries.", true);
              log("Displaying fallback instead.");
              loadFallbackModel();
            }
          }
        }

        async function loadFallbackModel() {
          const fallbackURL = "https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/CesiumMan/glTF-Binary/CesiumMan.glb";
          try {
            const fallbackModel = await Cesium.Model.fromGltfAsync({
              url: fallbackURL,
              modelMatrix: Cesium.Transforms.eastNorthUpToFixedFrame(
                Cesium.Cartesian3.fromDegrees(-118.4085, 33.9416, 1000)
              ),
              scale: 1.0,
            });
            viewer.scene.primitives.add(fallbackModel);
            log("Fallback GLB loaded.");
          } catch (error) {
            log("Fallback model also failed: " + error.message, true);
          }
        }

        await tryLoadModel();

      } catch (err) {
        log("Critical failure: " + err.message, true);
        document.body.style.background = "#300";
      }
    </script>
  </body>
</html>
